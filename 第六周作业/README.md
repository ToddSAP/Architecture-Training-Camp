### 简述CAP原理  
&nbsp;&nbsp;&nbsp;&nbsp;CAP是指Consistency、Availability和Partition Tolerence，即一致性、可用性和分区容忍性。    
&nbsp;&nbsp;&nbsp;&nbsp;CAP是用来指导分布式系统设计的理论基础。   
&nbsp;&nbsp;&nbsp;&nbsp;一致性是指分布式系统中所有节点上的数据都是强一致的。如Hadoop将文件冗余三份存储在HDFS上，这三份数据在任何时间点上被使用时都是相同的。   
&nbsp;&nbsp;&nbsp;&nbsp;可用性是指分布式系统中所有节点的数据在任何时间都是可以被访问到并被正确读取和使用的。   
&nbsp;&nbsp;&nbsp;&nbsp;分区容忍性是指分布式系统中部分节点损坏时，系统还是可用的。   
&nbsp;&nbsp;&nbsp;&nbsp;要明确这三点之间的关系，可以从分布式系统的结构说起。分布式系统顾名思义，是由分布在多个机器上的服务同时对外提供服务，现实中，机器一定会随时间推移而损坏，这是无法避免的，所以就需要在损坏时考虑系统还能否可用，数据是否丢失，数据是否一致这三个问题。先看第一个，如果要在机器损坏时让系统还可用，则必须做备份，在机器损坏时从备份恢复或切换到备份，但恢复或切换是需要时间的，在这个时间窗口中，系统的数据是不一致的。再看第二个，如果系统数据每个时刻都要一致，需要所有操作都是事务性的，而事务的性质决定了在高并发下无法做到高吞吐，那么必然有阻塞发生，对于系统来说就是卡顿或loading，是不可用状态。最后看第三个，分区容忍就是在机器损坏时保持高可用，那么从第一点的讨论来看，是无法做到一致性的。   
&nbsp;&nbsp;&nbsp;&nbsp;在实际工作中，需要根据场景来有侧重点的选择三者的关系。如在银行、证券交易场景下，数据一致性是第一位，那么必然要在一定程度上牺牲可用性。而在电商场景下，可用性是第一位的，那么数据一致性必然要有所妥协。  


### 总结   
这两周的内容都是分布式系统的核心知识，这些知识非常重要，但我更认同的是老师的问题导向论，准确定义了问题域，那么解决方案总是能找到的，即使一开始不完美，后续可以优化。而一开始就钻进各种"完美的"解决方案中则会有些本末倒置，让人不明觉厉，自然学习效果不好。  
我先总结我对分布式系统的认知过程及遇到的问题，再引导出解决方案。  
- 分布式系统的由来  
    - 在单机情况下，服务提供能力和数据存储能力都只能纵向扩展，即通过提升硬件的读写速度和存储容量来达成。而硬件的读写速度和存储容量的提升是有上限的，且提升的成本会急剧增加。  
    - 使用多台服务器联合提供服务的解决方案成为高并发场景下的唯一选择。  
    - 分布式是日益增长的性能需求和硬件成本显著增加之间矛盾的妥协  
    
- 分布式系统的架构  
    - 部署  
        - 相同或不同的服务部署在多台服务器上，服务器的位置可以随意，服务器间通过网络进行通信。  
    - 存储  
        - 数据被分片存储在不同的服务器上，为防止数据丢失，相同的数据可能会冗余分散存储在不同服务器上。  
        - 数据被访问时，通过系统配置获取数据所在服务器地址和路径，从多台服务器中加载数据。  
    - 计算  
        - 分别在不同放服务器上进行计算，然后将计算结果归并成最终结果。  
    
- 分布式系统的问题  
    - 网络或服务器硬件失效  
        - 当失效发生时，会导致请求无法分发到或无法处理，需要失效转移  
    - 数据不一致  
        - 多台服务器存储相同数据，一定需要数据同步，当同步失败时，一定会有数据不一致出现  
    - 路由  
        - 数据存储在不同服务器，需要系统管理在需要数据时如何能正确路由到数据所在服务器路径。     
        
- 分布式系统问题的解决方法    
    - 可用性  
        - 热备  
            - 主主复制、主从复制、一主多从、异地多活等部署方式，都是为了规避单点失效发生时，请求有可能被转移到可用的服务器上被处理。  
            - 系统需要主动监测失效发生，一旦发生，要尽可能快地做失效转移。  
            - 失效转移最好自动化，系统一旦监测到失效发生，按照事先做好的转移策略执行转移。  
            - 执行失效转移期间，系统是不可用的，但一般失效转移的时间窗非常短暂，往往让人无法察觉，故感觉上是一直可用的。  
        - 冷备  
            - 数据变更日志就在存储上，当失效发生时，通过日志恢复丢失数据。  
            - 一般的失效热备都可以解决，冷备只是做为热备无法解决时的最后手段。    
    - 一致性  
        - 由于数据分片和同步的存在，且网络和硬件故障无法避免，实时保证数据的一致性的代价高到远大于分布式可以获得的好处 -- 高性能，故只能视场景尽量保证数据一致性。  
        - 分布式中应用较多的是最终一致性，即通过定期或触发式的同步，让分布的数据最终走向一致，而走向一致的时间窗大小由同步的实现决定。  
        - 实现最终一致性的方式有很多，归纳起来主要有  
            - 用分布式事务，且业务可以做幂等。在分布式事务的某一环节失败后，直接重试，直到所有环节均成功。  
            - 用分布式事务，但业务无法做幂等。需要按业务规则分阶段依次提交，遇到失败时，需要补偿逻辑回滚之前已提交的数据。  
            - 用分段提交，用消息队列串联各分段，最终阶段提交成功则整个业务成功，否则分段重试或回滚。 
            - 整合所有业务接口调用到一个同步方法中，利用同步保证各个业务操作的整体事务性。  
    - 路由 
        - 路由算法是分布式系统的核心问题，在服务器伸缩、失效转移情况下正确路由是核心诉求。  
        - 余数哈希  
            - 在节点数量固定时应用，好处是简单直接，坏处是要求节点数量固定。   
        - 一致性哈希  
            - 利用哈希函数将服务器节点尽量均匀分布在有序线性表上，通过相同的哈希函数得到key的哈希值，再通过哈希值路由到最近的节点上。  
            - 好处是节点数量可随意变化，坏处是可能会出现数据偏斜，导致服务器负载不均衡。  
        - 轮询  
            - 适合无状态业务处理，好处是简单直接，坏处是业务要求无状态。  
        - 加权轮询 
            - 根据服务器硬件情况有选择的轮询分发请求，好处是简单直接，坏处是业务也要求无状态。  
            
      
    
